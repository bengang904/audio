<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>MP3 ID3 编辑器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/browser-id3-writer@4.4.0/dist/browser-id3-writer.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc; 
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start; 
    min-height: 100vh;
}

.container {
    width: 100%;
    max-width: 480px;
    background: #ffffff;
    padding: 30px;
    border-radius: 16px; 
    box-shadow: 0 15px 40px rgba(0,0,0,0.08); 
    border: 1px solid #eef1f5; 
}

h2 {
    margin-top: 0;
    margin-bottom: 25px;
    text-align: center;
    color: #333;
    font-weight: 700;
}

label {
    display: block;
    margin-top: 18px;
    margin-bottom: 4px;
    font-weight: 600;
    color: #555;
    font-size: 0.95em;
}

input[type="text"],
#fileInput-display { 
    width: 100%;
    padding: 12px 15px;
    margin-top: 4px;
    box-sizing: border-box;
    border: 1px solid #dcdfe6;
    border-radius: 8px; 
    transition: border-color 0.3s, box-shadow 0.3s;
    font-size: 1em;
    color: #333;
    background-color: #fff;
}

input[type="text"]:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15); 
    outline: none;
}

#fileInput, #coverInput {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

.file-input-wrapper {
    margin-top: 4px;
    display: flex;
    align-items: center;
}

.custom-file-upload {
    background-color: #4a90e2; 
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 500;
    transition: background-color 0.3s;
    flex-shrink: 0;
}

.custom-file-upload:hover {
    background-color: #3a7bd2;
}

#fileInput-filename, #coverInput-filename {
    margin-left: 10px;
    color: #666;
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#coverPreview {
    display: block;
    width: 100px; 
    height: 100px;
    object-fit: cover;
    margin: 15px auto 0 auto; 
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border: 1px solid #eee;
}

button {
    margin-top: 30px;
    width: 100%;
    padding: 14px;
    border: none;
    background: #4a72d8;
    color: white;
    font-size: 18px;
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.1s;
    box-shadow: 0 5px 15px rgba(61, 0, 184, 0.3);
}
</style>
</head>

<body>
<div class="container">
    <h2>MP3 ID3 编辑器</h2>
    
    <label for="fileInput">选择 MP3 文件</label>
    <div class="file-input-wrapper">
        <label for="fileInput" class="custom-file-upload">
            浏览文件...
        </label>
        <span id="fileInput-filename">未选择文件</span>
    </div>
    <input type="file" id="fileInput" accept=".mp3">
    
    <label for="title">标题</label>
    <input type="text" id="title" placeholder="歌曲标题">

    <label for="artist">艺术家</label>
    <input type="text" id="artist" placeholder="歌手名称">

    <label for="album">专辑</label>
    <input type="text" id="album" placeholder="所属专辑">

    <label for="year">年份</label>
    <input type="text" id="year" placeholder="发行年份 (如: 2023)">

    <label for="coverInput">封面（JPG / PNG）</label>
    <div class="file-input-wrapper">
        <label for="coverInput" class="custom-file-upload">
            选择封面...
        </label>
        <span id="coverInput-filename">未选择封面</span>
    </div>
    <input type="file" id="coverInput" accept="image/jpeg,image/png">
    <img id="coverPreview" style="display:none;" alt="专辑封面预览">

    <button id="saveBtn">保存并下载 MP3</button>
</div>

<script>
let mp3ArrayBuffer;
let coverArrayBuffer = null;
let coverMime = null;

const fileInput = document.getElementById('fileInput');
const coverInput = document.getElementById('coverInput');
const coverPreview = document.getElementById('coverPreview');
const fileInputFilename = document.getElementById('fileInput-filename');
const coverInputFilename = document.getElementById('coverInput-filename');
const title = document.getElementById('title');
const artist = document.getElementById('artist');
const album = document.getElementById('album');
const year = document.getElementById('year');


fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;
    
    fileInputFilename.textContent = file.name; 

    const reader = new FileReader();
    reader.onload = () => {
        mp3ArrayBuffer = reader.result;

        jsmediatags.read(file, {
            onSuccess: tag => {
                const t = tag.tags;
                title.value = t.title || '';
                artist.value = t.artist || '';
                album.value = t.album || '';
                year.value = t.year || '';

                if (t.picture) {
                    const picture = t.picture;
                    let base64String = "";
                    for (let i = 0; i < picture.data.length; i++) {
                        base64String += String.fromCharCode(picture.data[i]);
                    }
                    coverMime = picture.format;
                    const blob = new Blob([new Uint8Array(picture.data)], { type: picture.format });
                    const coverReader = new FileReader();
                    coverReader.onload = () => {
                        coverArrayBuffer = coverReader.result;
                        coverPreview.src = "data:" + picture.format + ";base64," + btoa(base64String);
                        coverPreview.style.display = 'block';
                        coverInputFilename.textContent = '已加载原有封面';
                    };
                    coverReader.readAsArrayBuffer(blob);
                } else {
                    coverPreview.style.display = 'none';
                    coverPreview.src = '';
                    coverArrayBuffer = null;
                    coverMime = null;
                    coverInputFilename.textContent = '未选择封面';
                }
            },
            onError: err => {
                console.warn('ID3 读取失败', err);
            }
        });
    };
    reader.readAsArrayBuffer(file);
});

coverInput.addEventListener('change', () => {
    const file = coverInput.files[0];
    if (!file) {
        coverPreview.style.display = 'none';
        coverInputFilename.textContent = '未选择封面';
        return; 
    }

    coverMime = file.type;
    coverInputFilename.textContent = file.name; 
    
    const reader = new FileReader();
    reader.onload = () => {
        coverArrayBuffer = reader.result;
        coverPreview.src = URL.createObjectURL(file);
        coverPreview.style.display = 'block';
    };
    reader.readAsArrayBuffer(file);
});

document.getElementById('saveBtn').onclick = () => {
    if (!mp3ArrayBuffer) {
        alert('请先选择 MP3 文件');
        return;
    }
    const writer = new ID3Writer(mp3ArrayBuffer);

    writer
        .setFrame('TIT2', title.value)
        .setFrame('TPE1', [artist.value])
        .setFrame('TALB', album.value)
        .setFrame('TYER', year.value);

    if (coverArrayBuffer && coverMime) {
        if (coverMime !== 'image/jpeg' && coverMime !== 'image/png') {
             alert(`不支持的封面格式: ${coverMime}。请选择 JPG 或 PNG。`);
             return;
        }

        writer.setFrame('APIC', {
            type: 3, 
            data: coverArrayBuffer,
            description: 'Cover',
            mimeType: coverMime
        });
    }

    writer.addTag(); 

    const blob = new Blob([writer.arrayBuffer], { type: 'audio/mpeg' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    const filename = (title.value || 'edited') + (artist.value ? (' - ' + artist.value) : '') + '.mp3';
    a.download = filename;
    a.click();

    URL.revokeObjectURL(url);
    alert(`文件 "${filename}" 已生成并开始下载!`);
};
</script>
</body>
</html>
